<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ActorReportDaoImpl" >

	
	<delete id="deleteActorGiftCnt" parameterClass="java.lang.String">
		delete from r_actor_gift_cnt where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<delete id="deleteActorGiftUserCnt" parameterClass="java.lang.String">
		delete from r_actor_gift_user_cnt where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<delete id="deleteActorGiftUnopenCnt" parameterClass="java.lang.String">
		delete from r_actor_gift_unopen_cnt where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<delete id="deleteActorGiftUnreplyCnt" parameterClass="java.lang.String">
		delete from r_actor_gift_unreply_cnt where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<delete id="deleteActorProjectCommonCnt" parameterClass="java.lang.String">
		delete from r_actor_project_common_cnt  where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<delete id="deleteActorProjectLogCnt" parameterClass="java.lang.String">
		delete from r_actor_projectlog_cnt where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<delete id="deleteActorFollowerCnt" parameterClass="java.lang.String">
		delete from r_actor_follower_cnt where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<delete id="deleteActorReport" parameterClass="java.lang.String">
		delete from r_actor_report where  date_format(create_date,'%Y-%m-%d') = #createDate#
	</delete>
	
	<insert id="insertActorGiftCnt" parameterClass="java.lang.String">
		insert into r_actor_gift_cnt 
		select gg.apply_account account , #createDate# , count(1) cnt , sum(gg.gift_jpoint) jpoint from u_gift_giving gg
		left join sp_gift_info g on g.gift_id = gg.gift_id
		where  date_format(str_to_date(gg.giving_date,'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d') &lt;= #createDate#
		group by gg.apply_account
	</insert>
	
	<insert id="insertActorGiftUserCnt" parameterClass="java.lang.String">
		insert into r_actor_gift_user_cnt 
		select t.apply_account account , #createDate# , count(1) from ( 
			select gg.apply_account , gg.opr_account , gg.giving_date from u_gift_giving gg where date_format(str_to_date(gg.giving_date,'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d') &lt;= #createDate# group by gg.apply_account , gg.opr_account 
		) t group by t.apply_account 
	</insert>
	
	<insert id="insertActorGiftUnopenCnt" parameterClass="java.lang.String">
		insert into r_actor_gift_unopen_cnt
		select gg.apply_account account , #createDate# , count(1) cnt from u_gift_giving gg
		left join sp_gift_info g on g.gift_id = gg.gift_id
		where  date_format(str_to_date(gg.giving_date,'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d') &lt;= #createDate# and is_opened = 'N'
		group by gg.apply_account 
	</insert>
	
	<insert id="insertActorGiftUnreplyCnt" parameterClass="java.lang.String">
		insert into r_actor_gift_unreply_cnt
		select gg.apply_account account , #createDate# ,count(1) cnt from u_gift_giving gg 
		where date_format(str_to_date(gg.giving_date,'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d') &lt;= #createDate# and gg.is_opened = 'Y' and reply_msg is null 
		group by gg.apply_account
	</insert>
	
	<insert id="insertActorProjectCommonCnt" parameterClass="java.lang.String">
		insert into r_actor_project_common_cnt 
		select  t.account account  , #createDate# , count(1) cnt from 
		(
		select c.user_account account from p_project_comment c 
		where date_format(str_to_date(c.create_date,'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d') &lt;= #createDate# 
		and exists ( select 1 from u_user_info u where c.user_account = u.account and u.user_role = 2 )  group by c.user_account 
		union all 
		select r.opr_account account from p_project_comment_reply r
		where date_format(str_to_date(r.create_date,'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d') &lt;= #createDate# 
		and exists ( select 1 from u_user_info u where r.opr_account = u.account and u.user_role = 2 )  group by r.opr_account 
		) t group by t.account
	</insert>
	
	<insert id="insertActorProjectLogCnt" parameterClass="java.lang.String">
		insert into r_actor_projectlog_cnt 
		select l.account account , count(1) cnt , #createDate# create_date from p_project_log_info l  where substr(l.create_date,1,10) &lt;= #createDate# group by l.account
	</insert>
	
	<insert id="insertActorFollowerCnt" parameterClass="java.lang.String">
		insert into r_actor_follower_cnt 
		select a.account account , count(1) cnt , #createDate# create_date from u_attention_info a  where substr(a.write_date,1,10) &lt;= #createDate# group by a.account 
	</insert>
	
	<insert id="insertActorReport" parameterClass="java.lang.String">
		insert into r_actor_report( account , create_date )
		select account , #createDate# from u_user_info u where u.user_role = 2
	</insert>
	
	<update id="updateActorReport" parameterClass="java.lang.String">
		update r_actor_report r 
		left join r_actor_gift_cnt gc on r.account = gc.account and r.create_date = gc.create_date
		left join r_actor_gift_user_cnt guc on r.account = guc.account and r.create_date = guc.create_date 
		left join r_actor_gift_unopen_cnt gunoc on r.account = gunoc.account and r.create_date = gunoc.create_date 
		left join r_actor_gift_unreply_cnt gunrc on r.account = gunrc.account and r.create_date = gunrc.create_date 
		left join r_actor_project_common_cnt pcc on r.account = pcc.account and r.create_date = pcc.create_date 
		left join r_actor_projectlog_cnt plc on r.account = plc.account and r.create_date = plc.create_date 
		left join r_actor_follower_cnt fc on r.account = fc.account and r.create_date = fc.create_date 
		set r.gc_cnt = gc.cnt, r.gc_jpoint = gc.jpoint , guc_cnt = guc.cnt, gunoc_cnt = gunoc.cnt, gunrc_cnt = gunrc.cnt , pcc_cnt = pcc.cnt , plc_cnt = plc.cnt, fc_cnt = fc.cnt
		where r.create_date = #createDate#
	</update>
	
	<select id="queryActorReport" parameterClass="com.fq.form.report.QueryActorReportForm" resultClass="com.fq.dao.entity.vo.report.ActorReportVO">
		select 
			r.create_date 	createDate	,
			r.gc_cnt 		gcCnt		, 
			r.gc_jpoint 	gcJpoint 	, 
			r.guc_cnt 		gucCnt		, 
			r.gunoc_cnt 	gunocCnt	, 
			r.gunrc_cnt 	gunrcCnt 	, 
			r.pcc_cnt 		pccCnt 		, 
			r.plc_cnt 		plcCnt		, 
			r.fc_cnt 		fcCnt 
		from r_actor_report r
		where r.account = #account# and r.create_date >= #selStartDate# 
		<dynamic>
			<isNotEmpty property="selEndDate" prepend="and"> <![CDATA[ r.create_date <= #selEndDate#  ]]> </isNotEmpty>
		</dynamic>
		order by r.create_date desc
		
	</select>
	
</sqlMap>