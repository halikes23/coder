<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="TradeConsumeReportDaoImpl" >

	<delete id="deleteTradeConsumeReport" parameterClass="java.util.Map">
		delete from r_trade_consume_report where create_date = #createDate# and report_cycle = #reportCycle# and client_channel = #clientChannel#
	</delete>
	
	<insert id="insertTradeConsumeReport" parameterClass="java.util.Map">
		insert into r_trade_consume_report values( #createDate# , #beginDate# , #reportCycle# , null , null ,null , #clientType# , #clientChannel# , #clientChannelName# ) ;
	</insert>
	
	<update id="updateTradeConsumeReport" parameterClass="java.util.Map">
		
		update r_trade_consume_report 
		set 
			register_cnt = ( 
				select count(1) from bt_user_info u 
				where u.write_date like  concat(#beginDate#,'%') and way != 2 and u.is_np = 'N' and
				exists ( select 1 from bt_client_info c where c.account = u.account and c.client_channel = #clientChannel# and c.is_np = 'N')
			),
			trade_cnt = 
				( 	select count(distinct a.entity_no) from tp_trade_app a 
					inner join bt_user_info u on a.entity_no = u.account and u.write_date like concat(#beginDate#,'%') and way != 2  and u.is_np = 'N'
					where busi_code = '7' and pmt_state = '2'  and a.app_dt &gt;= #tightBeginDate# and a.app_dt &lt; #tightCreateDate# and
							exists ( select 1 from bt_client_info c1 where c1.account = u.account and c1.client_channel = #clientChannel# and c1.is_np = 'N'  )
				) ,
			consume_cnt = 
				( select count(distinct l.account) from l_user_jpoint_log l ignore index(account)
					where l.write_date &gt;= #beginDate#  and l.write_date &lt; #createDate# and l.op in ( 7 , 11 , 15 , 16 , 17 , 18 , 22 ) and
							exists ( select 1 from bt_user_info u where u.account = l.account and u.write_date like concat(#beginDate#,'%') and way != 2  and u.is_np = 'N') and
                            exists ( select 1 from bt_client_info c1 where c1.account = l.account and c1.client_channel = #clientChannel# and c1.is_np = 'N'  )
				)
		where create_date = #createDate# and report_cycle = #reportCycle# and client_channel = #clientChannel#
		
	</update>
	
	<update id="updateTradeConsumeReportAll" parameterClass="java.util.Map">
		
		update r_trade_consume_report 
		set 
			register_cnt = ( 
				select count(1) from bt_user_info u 
				where u.write_date like  concat(#beginDate#,'%') and way != 2  and u.is_np = 'N'
			),
			trade_cnt = 
				( 	select count(distinct a.entity_no) from tp_trade_app a 
					inner join bt_user_info u on a.entity_no = u.account and u.write_date like concat(#beginDate#,'%') and way != 2 and u.is_np = 'N'
					where busi_code = '7' and pmt_state = '2'  and a.app_dt &gt;= #tightBeginDate# and a.app_dt &lt; #tightCreateDate#
				) ,
			consume_cnt = 
				( select count(distinct l.account) from l_user_jpoint_log l ignore index(account)
					where l.write_date &gt;= #beginDate#  and l.write_date &lt; #createDate# and l.op in ( 7 , 11 , 15 , 16 , 17 , 18 , 22 ) and
							exists ( select 1 from bt_user_info u where u.account = l.account and u.write_date like concat(#beginDate#,'%') and way != 2  and u.is_np = 'N')
				)
		where create_date = #createDate# and report_cycle = #reportCycle# and client_type = #clientType# and client_channel = #clientChannel#
		
	</update>
	
	<update id="updateUnknowTradeConsumeReport" parameterClass="java.util.Map">
		
		update r_trade_consume_report 
		set 
			register_cnt = ( 
				select count(1) from bt_user_info u 
				where u.write_date like  concat(#beginDate#,'%') and way != 2 and u.is_np = 'N' and
				not exists ( 
					select 1 from bt_client_info c
					inner join sp_sys_info s on s.key1 = 'reward' and s.key2 = 'register' and s.key3 = c.client_channel 
					where c.account = u.account  and c.is_np = 'N'
					union all 
					select 1 from bt_client_info c 
                    where c.account = u.account and c.client_type = 'I' and c.client_channel = 'IPHONE' and c.is_np = 'N'
				) 
			),
			trade_cnt = 
				( 	select count(distinct a.entity_no) from tp_trade_app a 
					inner join bt_user_info u on a.entity_no = u.account and u.write_date like concat(#beginDate#,'%') and way != 2 and u.is_np = 'N'
					where busi_code = '7' and pmt_state = '2'  and a.app_dt &gt;= #tightBeginDate# and a.app_dt &lt; #tightCreateDate# and
					not exists ( 
						select 1 from bt_client_info c
						inner join sp_sys_info s on s.key1 = 'reward' and s.key2 = 'register' and s.key3 = c.client_channel 
						where c.account = a.entity_no  and c.is_np = 'N'
						union all 
						select 1 from bt_client_info c 
	                    where c.account = a.entity_no and c.client_type = 'I' and c.client_channel = 'IPHONE' and c.is_np = 'N'
					) 
					
				) ,
			consume_cnt = 
				( select count(distinct l.account) from l_user_jpoint_log l ignore index(account)
					where l.write_date &gt;= #beginDate#  and l.write_date &lt; #createDate# and l.op in ( 7 , 11 , 15 , 16 , 17 , 18 , 22 ) and
							exists ( select 1 from bt_user_info u where u.account = l.account and u.write_date like concat(#beginDate#,'%') and way != 2  and u.is_np = 'N' ) and
                            not exists ( 
								select 1 from bt_client_info c 
								inner join sp_sys_info s on s.key1 = 'reward' and s.key2 = 'register' and s.key3 = c.client_channel 
								where c.account = l.account  and c.is_np = 'N'
								union all 
								select 1 from bt_client_info c 
			                    where c.account = l.account and c.client_type = 'I' and c.client_channel = 'IPHONE' and c.is_np = 'N'
							) 
				)
		where create_date = #createDate# and report_cycle = #reportCycle# and client_type = #clientType# and client_channel = #clientChannel#
		
	</update>
	
</sqlMap>