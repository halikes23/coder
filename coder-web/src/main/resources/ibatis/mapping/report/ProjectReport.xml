<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ProjectReportDaoImpl" >

	<delete id="deleteProjectReport" parameterClass="java.lang.String">
		delete from r_project_report where create_date = #createDate#
	</delete>
	
	<insert id="insertProjectReport" parameterClass="java.lang.String">
		insert into r_project_report 
		(
				pi_id	, create_date	, pc_cnt ,	pli_cnt	,	plc_cnt ,	plr_cnt , pcc_cnt , pbs_cnt , ps_cnt , pp_cnt , pco_cnt 
		)
		select pi.pi_id , #createDate# , pc.c_cnt , pli.pli_cnt ,plc.plc_cnt , plr.plr_cnt ,  pcc.pcc_cnt , pmc.pbs_cnt , rms.ps_cnt , rmc.pp_cnt , mcc.pco_cnt
		from p_project_info pi
		left join ( select pc.pi_id  , count(1) c_cnt from p_project_chase pc 			where date_format(pc.create_date,'%Y-%m-%d')	&lt;= #createDate# 	group by pc.pi_id  ) pc on pc.pi_id = pi.pi_id 
		left join ( select pli.pi_id , count(1) pli_cnt from p_project_log_info pli 	where date_format(pli.create_date,'%Y-%m-%d')	&lt;= #createDate# 	group by pli.pi_id ) pli on pli.pi_id = pi.pi_id
		left join ( select plc.pi_id , count(1) plc_cnt from p_project_log_comment plc 	where date_format(plc.create_date,'%Y-%m-%d') 	&lt;= #createDate# 	group by plc.pi_id ) plc on plc.pi_id = pi.pi_id
		left join ( 
						select pli.pi_id , count(1) plr_cnt from p_project_log_praise plr 	
						left join p_project_log_info pli on pli.pli_id = plr.pli_id
						where date_format(plr.create_date,'%Y-%m-%d') &lt;= #createDate# 	group by pli.pi_id ) plr on plr.pi_id = pi.pi_id
		left join (
					select pcc.pi_id   , count(1) pcc_cnt from p_project_comment pcc 
					where date_format(pcc.create_date,'%Y-%m-%d') &lt;=#createDate#  group by pcc.pi_id
					)  pcc on pcc.pi_id = pi.pi_id
		left join (
					select pmr.pi_id , sum(pmc.cnt) pbs_cnt from r_movie_bulletscreen_cnt pmc 
					left join p_project_movie_rel pmr on pmr.m_id = pmc.m_id
					where date_format(pmc.create_date,'%Y-%m-%d') = #createDate#
					group by pmr.pi_id
					) pmc  on pmc.pi_id = pi.pi_id		
		left join (
					select pmr.pi_id , sum(rms.cnt) ps_cnt from r_movie_share_cnt rms 
					left join p_project_movie_rel pmr on pmr.m_id = rms.m_id
					where date_format(rms.create_date,'%Y-%m-%d') = #createDate#
					group by pmr.pi_id
					) rms on rms.pi_id = pi.pi_id
		left join (
					select pmr.pi_id , sum(rmc.cnt) pp_cnt from r_movie_play_cnt rmc 
					left join p_project_movie_rel pmr on pmr.m_id = rmc.m_id
					where date_format(rmc.create_date,'%Y-%m-%d') = #createDate#
					group by pmr.pi_id
					) rmc on rmc.pi_id = pi.pi_id
		left join (
					select  sum(mcc.cnt) pco_cnt , pmr.pi_id 
					from  r_movie_collection_cnt mcc 
					left join p_project_movie_rel pmr on pmr.m_id = mcc.m_id
					where date_format(mcc.create_date,'%Y-%m-%d') = #createDate#
					group by pmr.pi_id  
					) mcc  on mcc.pi_id = pi.pi_id  
	</insert>
	
	
	<update id="updateProjectReport" parameterClass="java.lang.String" >
			update r_project_report pr set pr.por_cnt = (
			
				select count(pcr.opr_account)  from p_project_comment_reply pcr 
				
				left join p_project_info pi on pcr.pi_id = pi.pi_id 
				  
				where  pr.pi_id = pcr.pi_id and pr.create_date = #createDate# and  pi.project_owner_account = pcr.opr_account
				
				group by pcr.pi_id  
			) 
			
	</update>
	
	
	
	<select id="queryProjectReport" parameterClass="com.fq.form.report.QueryProjectReportForm" resultClass="com.fq.dao.entity.vo.report.ProjectReportVO">
		select 
			r.create_date 	createDate	,
			r.pc_cnt 		pcCnt		, 
			r.pli_cnt	 	pliCnt	 	, 
			r.plc_cnt 		plcCnt		, 
			r.plr_cnt	 	plrCnt      ,
			r.pcc_cnt       pccCnt      ,
			r.pbs_cnt		pbsCnt		,
			r.ps_cnt		psCnt		,
			r.pp_cnt		ppCnt 		,
			r.por_cnt		porCnt		,
			r.pco_cnt 		pcoCnt 
		from r_project_report r 
		where r.pi_id = #piId# and r.create_date >= #selStartDate# 
		<dynamic>
			<isNotEmpty property="selEndDate" prepend="and"> <![CDATA[ r.create_date <= #selEndDate#  ]]> </isNotEmpty>
		</dynamic>
		order by r.create_date desc
	</select>
	
	<update id="updateProjectCommentNumByPiId" parameterClass="java.util.Map">
		update r_project_report pr set pr.pcc_cnt = #cnt# where pr.pi_id = #piId# and pr.create_date = #createDate# 
	</update>
	
</sqlMap>